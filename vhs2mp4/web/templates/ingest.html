{% extends "layout.html" %}

{% block content %}
<section>
  <h2>Ingest Inbox</h2>
  <p>Review MP4 files in the active project inbox and ingest them into raw storage.</p>
  <p><strong>Best practice:</strong> Add tapes first (with label text), then attach MP4s during ingest.</p>
  <p>
    <small>
      NAS:
      {% if nas_available %}
        Available
      {% else %}
        Not Available (backups will be queued)
      {% endif %}
    </small>
  </p>
  {% if message %}
    <article>
      <strong>{{ message }}</strong>
    </article>
  {% endif %}
  {% if inbox_files %}
    <form method="post" action="{{ url_for('ingest_all') }}">
      <button type="submit">Ingest All</button>
    </form>
    <table>
      <thead>
        <tr>
          <th>Filename</th>
          <th>Filesize</th>
          <th>Modified</th>
          <th>Status</th>
          <th>Attach to Tape (optional)</th>
        </tr>
      </thead>
      <tbody>
        {% for file in inbox_files %}
          <tr>
            <td>{{ file.name }}</td>
            <td>{{ format_bytes(file.size_bytes) }}</td>
            <td>{{ file.modified_time }}</td>
            <td>
              {{ file.status }}
              {% if file.error %}
                <br /><small>{{ file.error }}</small>
              {% endif %}
            </td>
            <td>
              <form method="post" action="{{ url_for('ingest_file') }}">
                <input type="hidden" name="filename" value="{{ file.name }}" />
                <label>
                  <small>Attach to Tape (optional)</small><br />
                  <select name="tape_id">
                    <option value="">Auto-create</option>
                    {% for tape in unassigned_tapes %}
                      {% set display_title = tape.title or tape.source_label or "Untitled" %}
                      <option value="{{ tape.id }}">
                        {{ tape.tape_code or tape.id }} â€” {{ display_title }}
                      </option>
                    {% endfor %}
                  </select>
                </label>
                <button type="submit" {% if file.status != 'new' %}disabled{% endif %}>
                  Ingest
                </button>
              </form>
            </td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  {% else %}
    <p>No MP4 files found in the inbox.</p>
  {% endif %}
</section>
{% endblock %}
