{% extends "layout.html" %}

{% block content %}
<section>
  <h2>Ingest Inbox</h2>
  <p>Review MP4 files in the active project inbox and ingest them into raw storage.</p>
  <p><strong>Best practice:</strong> Add tapes first (with label text), then attach MP4s during ingest.</p>
  <p>
    <small>
      NAS:
      {% if nas_available %}
        <span class="nas-pill nas-pill--available">Available</span>
      {% else %}
        <span class="nas-pill nas-pill--unavailable">Not Available</span>
        (backups will be queued)
      {% endif %}
    </small>
  </p>
  {% if message %}
    <article>
      <strong>{{ message }}</strong>
    </article>
  {% endif %}
  {% if inbox_files %}
    <form method="post" action="{{ url_for('ingest_start_all') }}">
      <button type="submit">Ingest All</button>
    </form>
    {# Compact table layout keeps the list scannable without changing backend behavior. #}
    <table class="ingest-table">
      <thead>
        <tr>
          <th>File</th>
          <th>Size</th>
          <th>Status</th>
          <th>Attach</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody>
        {% for file in inbox_files %}
          <tr>
            <td class="ingest-file-cell">
              <span class="ingest-file-name" title="{{ file.name }}">{{ file.name }}</span>
              <span class="ingest-file-meta">{{ file.modified_time }}</span>
            </td>
            <td class="ingest-size-cell">{{ format_bytes(file.size_bytes) }}</td>
            <td class="ingest-status-cell">
              <span class="status-pill status-pill--{{ file.status }}">
                {{ file.status }}
              </span>
              {% if file.error %}
                <br /><small class="ingest-error">{{ file.error }}</small>
              {% endif %}
            </td>
            {% set form_id = "ingest-row-" ~ loop.index %}
            <td class="ingest-attach-cell">
              <select
                name="tape_id"
                form="{{ form_id }}"
                {% if file.status == 'ingested' %}disabled{% endif %}
              >
                <option value="">Auto-create</option>
                {% for tape in unassigned_tapes %}
                  {% set display_title = tape.title or tape.source_label or "Untitled" %}
                  <option value="{{ tape.id }}">
                    {{ tape.tape_code or tape.id }} â€” {{ display_title }}
                  </option>
                {% endfor %}
              </select>
            </td>
            <td class="ingest-action-cell">
              <form
                method="post"
                action="{{ url_for('ingest_start_file') }}"
                id="{{ form_id }}"
                class="ingest-row-form"
              >
                <input type="hidden" name="filename" value="{{ file.name }}" />
                <button type="submit" {% if file.status != 'new' %}disabled{% endif %}>
                  {% if file.status == 'ingested' %}
                    Ingested
                  {% else %}
                    Ingest
                  {% endif %}
                </button>
              </form>
            </td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  {% else %}
    <p>No MP4 files found in the inbox.</p>
  {% endif %}
</section>
{% endblock %}
