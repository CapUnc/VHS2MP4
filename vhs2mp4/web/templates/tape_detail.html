{% extends "layout.html" %}

{% block content %}
<section>
  <h2>Tape Details</h2>
  {% if not tape %}
    <p>Tape not found.</p>
  {% else %}
    <article>
      <h3>{{ tape.title }}</h3>
      <p><strong>Tape ID:</strong> {{ tape.tape_code or "—" }}</p>
      <p><strong>Status:</strong> {{ tape.status or "New" }}</p>
      <p><strong>Created:</strong> {{ tape.created_at }}</p>
      <h4>Label</h4>
      <p><strong>Tape Label Text:</strong> {{ tape.tape_label_text or "—" }}</p>
      <p><strong>Label Guess:</strong> {{ "Yes" if tape.label_is_guess else "No" }}</p>
      <p><strong>Source Label:</strong> {{ tape.source_label or "—" }}</p>
      <p><strong>Date Type:</strong> {{ tape.date_type }}</p>
      <p><strong>Exact Date:</strong> {{ tape.date_exact or "—" }}</p>
      <p><strong>Date Range:</strong> {{ tape.date_start or "—" }} → {{ tape.date_end or "—" }}</p>
      <p><strong>Date Locked:</strong> {{ "Yes" if tape.date_locked else "No" }}</p>
      <h4>Raw Media</h4>
      {% if tape.raw_filename %}
        <p><strong>Raw File:</strong> {{ tape.raw_filename }}</p>
        <p><strong>Ingested At:</strong> {{ tape.ingested_at or "—" }}</p>
        <p><strong>Duration:</strong> {{ format_timestamp(tape.duration_seconds) }}</p>
        <p><strong>File Size:</strong> {{ format_bytes(tape.file_size_bytes) if tape.file_size_bytes else "—" }}</p>
        <details>
          <summary>Raw file details</summary>
          <p><strong>Raw Path:</strong> {{ tape.raw_path or "—" }}</p>
          <p><strong>SHA256:</strong> {{ tape.sha256 or "—" }}</p>
        </details>
      {% elif tape.status == "New" %}
        <p>No raw file attached yet.</p>
      {% else %}
        <p><strong>Raw File:</strong> —</p>
      {% endif %}
      <p><strong>Backup Status:</strong> {{ tape.backup_status or "—" }}</p>
      <p><strong>Tags:</strong> {{ tags | join(", ") if tags else "—" }}</p>
      <p><strong>Notes:</strong> {{ tape.notes or "—" }}</p>
      <h4>Thumbnail</h4>
      {% if tape.thumb_path %}
        <img src="{{ url_for('tape_thumbnail', tape_id=tape.id) }}" alt="Thumbnail for {{ tape.tape_code }}" style="max-width: 100%; height: auto;" />
      {% else %}
        <p>No thumbnail yet.</p>
      {% endif %}
      {% if not ffmpeg_available %}
        <p><strong>ffmpeg is not installed.</strong> Install with <code>brew install ffmpeg</code> to enable thumbnails and scene suggestions.</p>
      {% endif %}
      <form method="post" action="{{ url_for('process_media_start', tape_id=tape.id) }}">
        <button type="submit">Generate Thumbnail + Suggest Scene Splits</button>
      </form>
      <h4>Suggested Splits</h4>
      {% if suggestions %}
        <ul>
          {% for suggestion in suggestions %}
            <li>Segment {{ loop.index }}: {{ format_timestamp(suggestion.start_seconds) }} to {{ format_timestamp(suggestion.end_seconds) }}</li>
          {% endfor %}
        </ul>
        <form method="post" action="{{ url_for('accept_suggestions', tape_id=tape.id) }}">
          <button type="submit">Accept Suggestions</button>
        </form>
        <form method="post" action="{{ url_for('ignore_suggestions', tape_id=tape.id) }}">
          <button type="submit">Ignore Suggestions</button>
        </form>
      {% else %}
        <p>No major scene changes detected.</p>
      {% endif %}
      <h4>Segments</h4>
      {% if segments %}
        {% if review_items %}
          {% for item in review_items %}
            {% if item.type == 'needs_export_review' and item.status == 'open' %}
              <p><strong>Export needs review:</strong> {{ item.message }}</p>
            {% endif %}
          {% endfor %}
        {% endif %}
        <p><strong>Output Folder:</strong> {{ segments_output_dir }}</p>
        <ul>
          {% for segment in segments %}
            {% set status = segment.export_status or 'not_exported' %}
            <li>
              Segment {{ loop.index }}: {{ format_timestamp(segment.start_seconds) }} to {{ format_timestamp(segment.end_seconds) }}
              — {{ "Exported" if status == "exported" else "Not exported" }}
            </li>
          {% endfor %}
        </ul>
        <form method="post" action="{{ url_for('export_segments_start', tape_id=tape.id) }}">
          <button type="submit">Export Segment Clips</button>
        </form>
      {% else %}
        <p>No segments to export yet. Accept suggestions or create segments first.</p>
      {% endif %}
    </article>
    <section>
      <h3>Review Queue</h3>
      {% if review_items %}
        <ul>
          {% for item in review_items %}
            <li>{{ item.type }} — {{ item.message }} ({{ item.status }})</li>
          {% endfor %}
        </ul>
      {% else %}
        <p>No review items yet.</p>
      {% endif %}
    </section>
  {% endif %}
</section>
{% endblock %}
